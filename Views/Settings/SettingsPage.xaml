<?xml version="1.0" encoding="utf-8" ?>
<shared:BasePage x:Name="Page"
    x:Class="SpiritualGiftsSurvey.Views.Settings.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:c="clr-namespace:SpiritualGiftsSurvey.Views.Controls;assembly=SpiritualGiftsSurvey"
    xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
    xmlns:shared="clr-namespace:SpiritualGiftsSurvey.Views.Shared;assembly=SpiritualGiftsSurvey"
    xmlns:vm="clr-namespace:SpiritualGiftsSurvey.Views.Settings"
    xmlns:r="clr-namespace:SpiritualGiftsSurvey.Routing"
    x:DataType="vm:SettingsViewModel"
    FlowDirection="{Binding FlowDirection}"
    NavigationPage.HasNavigationBar="False"
    Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <Style x:Key="TitleLabelStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{OnIdiom Phone=18, Tablet=26}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="TextColor" Value="Black" />
            <Setter Property="HorizontalOptions" Value="Start" />
        </Style>
        <Style x:Key="BodyLabelStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{OnIdiom Phone=14, Tablet=20}" />
            <Setter Property="TextColor" Value="Black" />
        </Style>
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid RowDefinitions="Auto,*">
            
            <!-- BACKGROUND -->
            <Image 
                Source="mainpagebackground"
                VerticalOptions="Fill"
                HorizontalOptions="Fill"
                Aspect="Fill"
                Grid.RowSpan="2" />

            <!-- NAVBAR -->
            <c:NavBar 
                Grid.Row="0" 
                Title="{Binding PageTopic}"
                ShowLeftButton="true"
                ShowRightButton="false"
                LeftCommand="{Binding NavBackCommand}"
                RightCommand="{Binding NavBackCommand}"
                LeftIcon="{StaticResource BackArrow}"
                RightIcon="{StaticResource BackArrowRight}"
                LeftCommandParameter="{x:Static r:Routes.WelcomePage}"
                RightCommandParameter="{x:Static r:Routes.WelcomePage}" />

            <c:LoadingOverlay Grid.Row="0" Grid.RowSpan="3" 
                              IsBusy="{Binding IsLoading}" 
                              Message="{Binding LoadingText}" />

            <!-- MAIN CONTENT -->
            <ScrollView Grid.Row="1">
                <StackLayout VerticalOptions="Start"
                             HorizontalOptions="Fill"
                             Margin="{OnIdiom Phone='20,20,20,40', Tablet='40,40,40,80'}"
                             Spacing="{OnIdiom Phone=20, Tablet=30}">

                    <!-- Language -->
                    <Grid Padding="{OnIdiom Phone='0,10,0,0', Tablet='0,20,0,0'}"
                          RowDefinitions="Auto"
                          ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0" 
                               Text="{Binding CurrentLanguageTitle}"
                               Style="{StaticResource TitleLabelStyle}" />

                        <Label Grid.Column="1"
                               Text="{Binding SelectedLanguage.DisplayName}"
                               VerticalOptions="Center"
                               Style="{StaticResource BodyLabelStyle}" />

                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="StudentLanguage_Tapped" />
                        </Grid.GestureRecognizers>
                    </Grid>

                    <Picker x:Name="LanguagePicker"
                            Title="{Binding LanguageTitle}"
                            SelectedItem="{Binding SelectedLanguage}"
                            ItemsSource="{Binding LanguageOptions}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            IsVisible="{Binding ShowLanguagePicker}"
                            ios:Picker.UpdateMode="WhenFinished" />

                    <BoxView HeightRequest="0.5" HorizontalOptions="Fill" BackgroundColor="Gray" />

                    <!-- Reporting Email -->
                    <Label Text="{Binding ReportingEmailsTitle}"
                           Style="{StaticResource TitleLabelStyle}" />

                    <Border Stroke="Gray"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 12"
                            BackgroundColor="White"
                            Padding="{OnIdiom Phone=10, Tablet=20}"
                            Margin="{OnIdiom Phone='0,10,0,0', Tablet='0,20,0,0'}">

                        <VerticalStackLayout Spacing="{OnIdiom Phone=10, Tablet=20}">
                            <Grid ColumnDefinitions="*,Auto"
                                  HorizontalOptions="Fill"
                                  VerticalOptions="Center">

                                <Entry x:Name="AddReportingEmailEntry"
                                       Grid.Column="0"
                                       Placeholder="{Binding AddReportingEmailPlaceholder}"
                                       Text="{Binding NewReportingEmail}"
                                       TextColor="{Binding AddReportingEmailTextColor}"
                                       TextChanged="Entry_TextChanged"
                                       Keyboard="Email" />

                                <ImageButton Grid.Column="1"
                                             Source="{StaticResource AddEmail}"
                                             WidthRequest="30"
                                             HeightRequest="30"
                                             Margin="{OnIdiom Phone='0,0,5,10', Tablet='0,0,5,20'}"
                                             Padding="4"
                                             CornerRadius="15"
                                             BackgroundColor="{StaticResource EmeraldGreen}"
                                             Command="{Binding AddNewReportingEmailCommand}" />
                            </Grid>

                            <BoxView HeightRequest="0.5" HorizontalOptions="Fill" BackgroundColor="Gray" IsVisible="{Binding ShowCollectionView}" />

                            <CollectionView ItemsSource="{Binding ReportingEmails}" IsVisible="{Binding ShowCollectionView}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <Grid Padding="{OnIdiom Phone=10, Tablet=20}" ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding}" FontSize="Small" TextColor="Black" HorizontalOptions="Start" />
                                            <ImageButton Source="{StaticResource DeleteEmail}"
                                                         Grid.Column="1"
                                                         WidthRequest="24"
                                                         HeightRequest="24"
                                                         BackgroundColor="Transparent"
                                                         Command="{Binding BindingContext.RemoveReportingEmailCommand, Source={x:Reference Name=Page}}"
                                                         CommandParameter="{Binding}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <StackLayout IsVisible="{Binding ShowDebugOptions}" Padding="0" Spacing="20">
                        <Label Text="Debug Options"
                               FontSize="Title"
                               FontAttributes="Bold"
                               TextColor="Black"
                               HorizontalOptions="Start" />

                        <Grid ColumnDefinitions="*,Auto,Auto" VerticalOptions="Center">
                            <Label Text="Total Topics" TextColor="Black" VerticalOptions="Center" FontSize="Body" />
                            <Label Grid.Column="1" Text="{Binding TotalTopics}" VerticalOptions="Center" TextColor="Black" Margin="10,0" />
                            <Stepper Grid.Column="2" Minimum="0" Maximum="50" Increment="1" Value="{Binding TotalTopics}" />
                        </Grid>

                        <Grid ColumnDefinitions="*,Auto,Auto" VerticalOptions="Center">
                            <Label Text="Topic Limit" TextColor="Black" VerticalOptions="Center" FontSize="Body" />
                            <Label Grid.Column="1" Text="{Binding TopicLimit}" VerticalOptions="Center" TextColor="Black" Margin="10,0" />
                            <Stepper Grid.Column="2" Minimum="0" Maximum="50" Increment="1" Value="{Binding TopicLimit}" />
                        </Grid>

                        <Grid VerticalOptions="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{OnIdiom Phone=20, Tablet=80}" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="1" Text="Total Questions" TextColor="Black" VerticalOptions="Center" FontSize="Body" FontAttributes="Bold" />
                            <Label Grid.Column="2" Text="{Binding TotalQuestions}" VerticalOptions="Center" TextColor="Black" Margin="10,0" FontAttributes="Bold" />
                        </Grid>

                        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                            <Label Text="Allow Unanswered Questions" TextColor="Black" VerticalOptions="Center" FontSize="Body" />
                            <Switch Grid.Column="1" IsToggled="{Binding AllowUnansweredQuestions}" />
                        </Grid>

                        <Grid ColumnDefinitions="*,Auto,Auto" VerticalOptions="Center" IsVisible="{Binding ShowUnansweredQuestionControls}">
                            <Label Text="Total Unanswered Questions" TextColor="Black" VerticalOptions="Center" FontSize="Body" />
                            <Label Grid.Column="1" Text="{Binding TotalUnansweredQuestions}" VerticalOptions="Center" TextColor="Black" Margin="10,0" />
                            <Stepper Grid.Column="2" Minimum="0" Maximum="100" Increment="1" Value="{Binding TotalUnansweredQuestions}" />
                        </Grid>
                    </StackLayout>

                </StackLayout>
            </ScrollView>

            <ContentView x:Name="actIndBackground" BackgroundColor="#222222" Opacity="0.65" Grid.RowSpan="2" IsVisible="{Binding IsLoading}" />
            <StackLayout Orientation="Vertical" IsVisible="{Binding IsLoading}" WidthRequest="300" HeightRequest="100" HorizontalOptions="Center" VerticalOptions="Center">
                <ActivityIndicator IsRunning="True" Color="{StaticResource WhiteSmoke}" />
                <Label Text="{Binding LoadingText}" HorizontalOptions="Center" TextColor="{StaticResource WhiteSmoke}" />
            </StackLayout>
        </Grid>
    </ContentPage.Content>
</shared:BasePage>
