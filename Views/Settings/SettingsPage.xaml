<?xml version="1.0" encoding="utf-8" ?>
<shared:BasePage x:Name="Page"
    x:Class="SpiritualGiftsSurvey.Views.Settings.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:c="clr-namespace:SpiritualGiftsSurvey.Views.Controls;assembly=SpiritualGiftsSurvey"
    xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
    xmlns:shared="clr-namespace:SpiritualGiftsSurvey.Views.Shared;assembly=SpiritualGiftsSurvey"
    xmlns:vm="clr-namespace:SpiritualGiftsSurvey.Views.Settings"
    xmlns:r="clr-namespace:SpiritualGiftsSurvey.Routing"
    x:DataType="vm:SettingsViewModel"
    FlowDirection="{Binding FlowDirection}"
    NavigationPage.HasNavigationBar="False"
    Shell.NavBarIsVisible="False">

    <ContentPage.Content>
        <Grid RowDefinitions="Auto,*">
            <!-- BG -->
            <Image Source="mainpagebackground"
                   VerticalOptions="Fill"
                   HorizontalOptions="Fill"
                   Aspect="Fill"
                   Grid.RowSpan="2" />

            <!-- NAVBAR (matches AppInfoPage) -->
            <Grid Grid.Row="0"
                  ColumnDefinitions="Auto,*,Auto"
                  Padding="10"
                  VerticalOptions="Start"
                  BackgroundColor="Transparent">

                <!-- Back -->
                <ImageButton x:Name="BackArrow"
                             Grid.Column="0"
                             HorizontalOptions="Start"
                             VerticalOptions="Center"
                             WidthRequest="40"
                             HeightRequest="40"
                             BackgroundColor="Transparent"
                             Source="{StaticResource BackArrow}"
                             Command="{Binding NavBackCommand}"
                             CommandParameter="{x:Static r:Routes.WelcomePage}" />

                <!-- Title -->
                <c:TitleLabel Grid.Column="1"
                              HorizontalOptions="End"
                              VerticalOptions="Center"
                              NewStyle="{StaticResource NavTitleLabelStyle}"
                              LabelText="{Binding PageTopic}"
                              Margin="0,0,20,0" />

                <ImageButton x:Name="BackArrowRight"
                             Grid.Column="2"
                             HorizontalOptions="End"
                             VerticalOptions="Center"
                             WidthRequest="40"
                             HeightRequest="40"
                             BackgroundColor="Transparent"
                             IsVisible="False"
                             IsEnabled="False"
                             Source="{StaticResource BackArrowRight}"
                             Command="{Binding NavBackCommand}"
                             CommandParameter="{x:Static r:Routes.WelcomePage}" />
            </Grid>

            <!-- MAIN CONTENT -->
            <ScrollView Grid.Row="1">
                <StackLayout VerticalOptions="Start"
                             HorizontalOptions="Fill"
                             Margin="20,20,20,40"
                             Spacing="30">

                    <!-- Language -->

                    <Grid Padding="0,10"
                          RowDefinitions="Auto"
                          ColumnDefinitions="*,Auto">
                        
                        <!-- Title -->
                        <Label Grid.Column="0" 
                            Text="{Binding CurrentLanguageTitle}"
                            FontSize="Title"
                            FontAttributes="Bold"
                            TextColor="Black"
                            HorizontalOptions="Start" />

                        <!-- Selected -->
                        <Label Grid.Column="1"
                               Text="{Binding SelectedLanguage.DisplayName}"
                               VerticalOptions="Center"
                               TextColor="Black" />

                        <!-- Tap Gesture -->
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="StudentLanguage_Tapped" />
                        </Grid.GestureRecognizers>
                    </Grid>

                    <!-- Hidden Picker -->
                    <Picker x:Name="LanguagePicker"
                            Title="{Binding LanguageTitle}"
                            SelectedItem="{Binding SelectedLanguage}"
                            ItemsSource="{Binding LanguageOptions}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            IsVisible="{Binding ShowLanguagePicker}"
                            ios:Picker.UpdateMode="WhenFinished" />

                    <BoxView HeightRequest="0.5" HorizontalOptions="Fill" BackgroundColor="Gray" />

                    <!-- Reporting Email -->
                    <Label Text="{Binding ReportingEmailsTitle}"
                           FontSize="Title"
                           FontAttributes="Bold"
                           TextColor="Black"
                           HorizontalOptions="Start" />

                    <Border 
                        Stroke="Gray"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 12"
                        BackgroundColor="White"
                        Padding="10"
                        Margin="0,10,0,0">

                        <VerticalStackLayout Spacing="10">

                            <!-- Input Grid -->
                            <Grid ColumnDefinitions="*,Auto"
                                HorizontalOptions="Fill"
                                VerticalOptions="Center">

                                <!-- Entry -->
                                <Entry 
                                    x:Name="AddReportingEmailEntry"
                                    Grid.Column="0"
                                    Placeholder="{Binding AddReportingEmailPlaceholder}"
                                    Text="{Binding NewReportingEmail}"
                                    TextColor="{Binding AddReportingEmailTextColor}"
                                    TextChanged="Entry_TextChanged"
                                    Keyboard="Email" />

                                <!-- Add Button -->
                                <ImageButton 
                                    Grid.Column="1"
                                    Source="{StaticResource AddEmail}"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Margin="0,0,5,10"
                                    Padding="4"
                                    CornerRadius="15"
                                    BackgroundColor="{StaticResource EmeraldGreen}"
                                    Command="{Binding AddNewReportingEmailCommand}" />
                            </Grid>

                            <!-- Divider -->
                            <BoxView 
                                HeightRequest="0.5" 
                                HorizontalOptions="Fill" 
                                BackgroundColor="Gray" 
                                IsVisible="{Binding ShowCollectionView}"/>

                            <!-- Email List -->
                            <CollectionView 
                                ItemsSource="{Binding ReportingEmails}"
                                IsVisible="{Binding ShowCollectionView}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <Grid Padding="10"
                                            ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding}"
                                                FontSize="Small"
                                                TextColor="Black"
                                                HorizontalOptions="Start" />
                                            <ImageButton 
                                                Source="{StaticResource DeleteEmail}"
                                                Grid.Column="1"
                                                WidthRequest="24"
                                                HeightRequest="24" 
                                                BackgroundColor="Transparent"
                                                Command="{Binding BindingContext.RemoveReportingEmailCommand, Source={x:Reference Name=Page}}"
                                                CommandParameter="{Binding}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                        </VerticalStackLayout>
                        
                    </Border>

                    <BoxView HeightRequest="0.5" HorizontalOptions="Fill" BackgroundColor="Gray" />

                    <HorizontalStackLayout
                        HorizontalOptions="Center"
                        Spacing="20"
                        WidthRequest="{OnIdiom Phone=320, Tablet=600}">

                        <!-- Restore Database Button (wrapped) -->
                        <Border
                            BackgroundColor="{StaticResource AzureBlue}"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 8"
                            WidthRequest="{OnIdiom Phone=150, Tablet=290}"
                            HeightRequest="50">

                            <Label
                                Text="{Binding RestoreDatabase}"
                                TextColor="White"
                                FontAttributes="Bold"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                HorizontalTextAlignment="Center"
                                VerticalTextAlignment="Center"
                                LineBreakMode="WordWrap"
                                Padding="10,5">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding RestoreDatabaseCommand}" />
                                </Label.GestureRecognizers>
                            </Label>
                        </Border>

                        <!-- Clear Data Button (wrapped) -->
                        <Border
                            BackgroundColor="{StaticResource DangerRed}"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 8"
                            WidthRequest="{OnIdiom Phone=150, Tablet=290}"
                            HeightRequest="50">

                            <Label
                                Text="{Binding ClearData}"
                                TextColor="Yellow"
                                FontAttributes="Bold"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                HorizontalTextAlignment="Center"
                                VerticalTextAlignment="Center"
                                LineBreakMode="WordWrap"
                                Padding="10,5">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ClearDataCommand}" />
                                </Label.GestureRecognizers>
                            </Label>
                        </Border>

                    </HorizontalStackLayout>

                    <!-- DEBUG SETTINGS -->
                    <StackLayout IsVisible="{Binding ShowDebugOptions}"
                        Padding="0"
                        Spacing="20">

                        <Label Text="Debug Options"
                            FontSize="Title"
                            FontAttributes="Bold"
                            TextColor="Black"
                            HorizontalOptions="Start" />

                        <!-- Total Topics -->
                        <Grid ColumnDefinitions="*,Auto,Auto"
                            VerticalOptions="Center">
                            <Label Text="Total Topics"
                                TextColor="Black"
                                VerticalOptions="Center"
                                FontSize="Body" />
                            <Label Grid.Column="1"
                                Text="{Binding TotalTopics}"
                                VerticalOptions="Center"
                                TextColor="Black"
                                Margin="10,0" />
                            <Stepper Grid.Column="2"
                                Minimum="0"
                                Maximum="200"
                                Increment="1"
                                Value="{Binding TotalTopics}" />
                        </Grid>

                        <!-- Topic Limit -->
                        <Grid ColumnDefinitions="*,Auto,Auto"
                            VerticalOptions="Center">
                            <Label Text="Topic Limit"
                                TextColor="Black"
                                VerticalOptions="Center"
                                FontSize="Body" />
                            <Label Grid.Column="1"
                                Text="{Binding TopicLimit}"
                                VerticalOptions="Center"
                                TextColor="Black"
                                Margin="10,0" />
                            <Stepper Grid.Column="2"
                                Minimum="0"
                                Maximum="50"
                                Increment="1"
                                Value="{Binding TopicLimit}" />
                        </Grid>

                        <!-- Total Questions -->
                        <Grid VerticalOptions="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{OnIdiom Phone=20, Tablet=80}" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="1"
                                Text="Total Questions"
                                TextColor="Black"
                                VerticalOptions="Center"
                                FontSize="Body"
                                FontAttributes="Bold"/>
                            <Label Grid.Column="2"
                                Text="{Binding TotalQuestions}"
                                VerticalOptions="Center"
                                TextColor="Black"
                                Margin="10,0"
                                FontAttributes="Bold"/>
                        </Grid>

                        <!-- Allow Unanswered Questions -->
                        <Grid ColumnDefinitions="*,Auto"
                            VerticalOptions="Center">
                            <Label Text="Allow Unanswered Questions"
                                TextColor="Black"
                                VerticalOptions="Center"
                                FontSize="Body" />
                            <Switch Grid.Column="1"
                                IsToggled="{Binding AllowUnansweredQuestions}" />
                        </Grid>

                        <!-- Total Unanswered Questions -->
                        <Grid ColumnDefinitions="*,Auto,Auto"
                            VerticalOptions="Center"
                            IsVisible="{Binding ShowUnansweredQuestionControls}">
                            <Label Text="Total Unanswered Questions"
                                TextColor="Black"
                                VerticalOptions="Center"
                                FontSize="Body" />
                            <Label Grid.Column="1"
                                Text="{Binding TotalUnansweredQuestions}"
                                VerticalOptions="Center"
                                TextColor="Black"
                                Margin="10,0" />
                            <Stepper Grid.Column="2"
                                Minimum="0"
                                Maximum="100"
                                Increment="1"
                                Value="{Binding TotalUnansweredQuestions}" />
                        </Grid>
                    </StackLayout>

                </StackLayout>
            </ScrollView>

            <!-- Loading overlay -->
            <ContentView x:Name="actIndBackground"
                         BackgroundColor="#222222"
                         Opacity="0.65"
                         Grid.RowSpan="2"
                         IsVisible="{Binding IsLoading}" />
            <StackLayout Orientation="Vertical"
                         IsVisible="{Binding IsLoading}"
                         WidthRequest="300"
                         HeightRequest="100"
                         HorizontalOptions="Center"
                         VerticalOptions="Center">
                <ActivityIndicator IsRunning="True"
                                   Color="{StaticResource WhiteSmoke}" />
                <Label Text="{Binding LoadingText}"
                       HorizontalOptions="Center"
                       TextColor="{StaticResource WhiteSmoke}" />
            </StackLayout>

        </Grid>
    </ContentPage.Content>

</shared:BasePage>
